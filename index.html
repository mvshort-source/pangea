<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Pangea</title>
  <meta name="theme-color" content="#0D0D0D"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <style>*{box-sizing:border-box;margin:0;padding:0;}body{background:#F7F4EE;}</style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
const { useState, useRef, useEffect } = React;

const C = {
  black:    "#0D0D0D",
  offblack: "#1A1A1A",
  charcoal: "#2E2E2E",
  grey:     "#6B6B6B",
  silver:   "#A8A8A0",
  fog:      "#D8D5CE",
  cream:    "#F7F4EE",
  green:    "#1B4D35",
  greenlt:  "#2A6B4A",
  navy:     "#0D1B2A",
  white:    "#FFFFFF",
};

const PANELS = [
  { id: "currents",   label: "Currents",   icon: "ã€œ", color: C.navy     },
  { id: "wharton",    label: "Wharton",    icon: "â—ˆ",  color: "#1A5276"  },
  { id: "techai",     label: "Tech & AI",  icon: "â¬¡",  color: C.offblack },
  { id: "money",      label: "Money",      icon: "â—†",  color: "#1E5B1E"  },
  { id: "creativity", label: "Creativity", icon: "âœ³",  color: C.green    },
  { id: "soul",       label: "The Soul",   icon: "âœ¦",  color: "#4A3020"  },
];

const STORAGE_KEYS = {
  entries:  "pangea-v2-entries",
  queue:    "pangea-v2-queue",
  books:    "pangea-v2-books",
};

const MOTTO = "I did not know what I thought until I wrote it down.";

// â”€â”€ Storage polyfill â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const _st = {
  get: async (k) => {
    if (window.storage && typeof window.storage.get === "function")
      try { return await window.storage.get(k); } catch(e) {}
    try { const v = localStorage.getItem(k); return v ? { value: v } : null; } catch { return null; }
  },
  set: async (k, v) => {
    if (window.storage && typeof window.storage.set === "function")
      try { return await window.storage.set(k, v); } catch(e) {}
    try { localStorage.setItem(k, v); return { key: k, value: v }; } catch { return null; }
  },
};

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function analyzeWithClaude(tab, file, urlVal) {
  const panelList = "currents, wharton, techai, money, creativity, soul";
  const messages = [];
  if (tab === "url") {
    messages.push({ role:"user", content:`Analyze this URL and return ONLY a JSON object with: "title" (clean source title), "summary" (3-5 sentence intelligent prose summary of the key ideas), "suggestedPanels" (array of 1-2 panel IDs from: ${panelList}). URL: ${urlVal}` });
  } else {
    const base64 = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result.split(",")[1]); r.onerror=rej; r.readAsDataURL(file); });
    const isImage = file.type.startsWith("image/");
    messages.push({ role:"user", content:[
      isImage ? {type:"image",source:{type:"base64",media_type:file.type,data:base64}} : {type:"document",source:{type:"base64",media_type:"application/pdf",data:base64}},
      {type:"text",text:`Analyze this ${isImage?"image":"document"} and return ONLY a JSON object with: "title" (clean descriptive title), "summary" (3-5 sentence intelligent prose summary), "suggestedPanels" (array of 1-2 IDs from: ${panelList}).`}
    ]});
  }
  const res = await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages})});
  if (!res.ok) { const e=await res.json().catch(()=>({})); throw new Error(e?.error?.message||`API error ${res.status}`); }
  const data = await res.json();
  const text = data.content.map(b=>b.text||"").join("").trim().replace(/^```json\s*/i,"").replace(/^```\s*/i,"").replace(/```\s*$/i,"").trim();
  return JSON.parse(text);
}

function highlight(text, q) {
  if (!q.trim()) return text;
  const parts = text.split(new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi"));
  return parts.map((p,i)=>i%2===1?`<mark>${p}</mark>`:p).join("");
}

function ts() {
  const d = new Date();
  return {
    date: d.toLocaleDateString("en-US",{month:"short",day:"numeric"}).toUpperCase(),
    time: d.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}),
  };
}

const badgeMap = {pdf:"PDF",slides:"SLIDES",url:"LINK",image:"IMAGE"};

// â”€â”€ CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CSS = "\n@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400;1,700&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap');\n*{box-sizing:border-box;margin:0;padding:0;}\nbody{background:#F7F4EE;-webkit-font-smoothing:antialiased;}\n\n/* NAV */\n.nav{border-bottom:4px solid #0D0D0D;padding:0 40px;display:flex;align-items:stretch;justify-content:space-between;background:#F7F4EE;position:sticky;top:0;z-index:100;}\n.nav-wm{font-family:'Playfair Display',serif;font-size:24px;font-weight:900;letter-spacing:10px;text-transform:uppercase;padding:16px 28px 16px 0;color:#0D0D0D;cursor:pointer;border-right:4px solid #0D0D0D;display:flex;align-items:center;}\n.nav-wm-g{color:#1B4D35;}\n.nav-links{display:flex;}\n.nav-link{padding:0 20px;font-family:'DM Mono',monospace;font-size:10px;font-weight:500;letter-spacing:2px;text-transform:uppercase;cursor:pointer;border:none;background:none;border-right:1px solid #D8D5CE;color:#6B6B6B;transition:all .15s;}\n.nav-link:last-child{border-right:none;}\n.nav-link:hover,.nav-link.active{background:#0D0D0D;color:#F7F4EE;}\n.nav-add{color:#1B4D35;border-left:4px solid #1B4D35;font-weight:600;}\n.nav-add:hover{background:#1B4D35 !important;color:#FFFFFF !important;}\n\n/* MASTHEAD */\n.masthead{background:#0D0D0D;padding:10px 40px;display:flex;justify-content:space-between;align-items:center;border-bottom:3px solid #1B4D35;gap:24px;}\n.masthead-l{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:#A8A8A0;text-transform:uppercase;white-space:nowrap;}\n.masthead-c{font-family:'Playfair Display',serif;font-size:14px;font-style:italic;color:#F7F4EE;text-align:center;flex:1;opacity:.9;}\n.masthead-r{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:#1B4D35;text-transform:uppercase;white-space:nowrap;}\n\n/* SEARCH */\n.search-wrap{border-bottom:4px solid #0D0D0D;padding:0 40px;background:#F7F4EE;display:flex;align-items:center;gap:16px;}\n.search-input{flex:1;border:none;background:transparent;font-family:'Playfair Display',serif;font-size:20px;outline:none;padding:18px 0;color:#0D0D0D;}\n.search-input::placeholder{color:#D8D5CE;}\n.search-count{font-family:'DM Mono',monospace;font-size:10px;color:#6B6B6B;letter-spacing:1px;white-space:nowrap;}\n.search-clear{background:none;border:1px solid #D8D5CE;padding:5px 14px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;cursor:pointer;color:#6B6B6B;transition:all .15s;}\n.search-clear:hover{border-color:#0D0D0D;color:#0D0D0D;}\n.search-results{padding:40px;}\n.sr-hdr{font-family:'Playfair Display',serif;font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;margin-bottom:28px;border-bottom:2px solid #0D0D0D;padding-bottom:14px;color:#0D0D0D;}\n.sr-entry{padding:24px 0;border-bottom:1px solid #D8D5CE;cursor:pointer;}\n.sr-entry:hover .j-txt{color:#1B4D35;}\nmark{background:#C8DDD0;padding:0 2px;color:#0D0D0D;}\n\n/* READING NOW */\n.reading-now{border-bottom:4px solid #0D0D0D;display:grid;grid-template-columns:200px 1fr;}\n.rn-label-col{background:#0D0D0D;padding:32px 28px;display:flex;flex-direction:column;justify-content:space-between;}\n.rn-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#1B4D35;margin-bottom:12px;}\n.rn-icon{font-size:32px;opacity:.15;color:#FFFFFF;}\n.rn-body{padding:28px 40px;display:flex;gap:20px;flex-wrap:wrap;align-items:center;}\n.rn-book{border:2px solid #D8D5CE;padding:14px 18px;display:flex;align-items:center;gap:14px;background:#FFFFFF;min-width:200px;max-width:320px;position:relative;}\n.rn-book-spine{width:4px;align-self:stretch;background:var(--bc);flex-shrink:0;}\n.rn-book-info{}\n.rn-book-title{font-family:'Playfair Display',serif;font-size:15px;font-weight:700;color:#0D0D0D;line-height:1.2;margin-bottom:3px;}\n.rn-book-author{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:#6B6B6B;}\n.rn-book-del{position:absolute;top:6px;right:8px;background:none;border:none;cursor:pointer;color:#D8D5CE;font-size:11px;transition:color .15s;}\n.rn-book-del:hover{color:#8B2000;}\n.rn-add{border:2px dashed #D8D5CE;padding:14px 18px;cursor:pointer;display:flex;align-items:center;gap:10px;transition:all .2s;background:none;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#A8A8A0;}\n.rn-add:hover{border-color:#1B4D35;color:#1B4D35;}\n.rn-add-form{display:flex;gap:0;border:2px solid #0D0D0D;min-width:340px;}\n.rn-add-inp{flex:1;border:none;outline:none;padding:12px 14px;font-family:'Playfair Display',serif;font-size:14px;color:#0D0D0D;background:#FFFFFF;}\n.rn-add-inp::placeholder{color:#D8D5CE;}\n.rn-add-btn{background:#0D0D0D;color:#FFFFFF;border:none;padding:0 16px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;cursor:pointer;white-space:nowrap;}\n.rn-add-btn:hover{background:#1B4D35;}\n\n/* WRITE BAR */\n.write-bar{background:#1A1A1A;border-bottom:4px solid #1B4D35;padding:0 40px;display:flex;gap:0;align-items:stretch;min-height:58px;}\n.write-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#1B4D35;white-space:nowrap;display:flex;align-items:center;padding-right:20px;border-right:1px solid #2E2E2E;margin-right:20px;}\n.write-input{flex:1;background:transparent;border:none;color:#F7F4EE;font-family:'Playfair Display',serif;font-size:17px;padding:0;outline:none;}\n.write-input::placeholder{color:#3A3A3A;}\n.write-sel{background:transparent;border:none;border-left:1px solid #2E2E2E;color:#A8A8A0;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:0 16px;outline:none;cursor:pointer;}\n.write-sel option{background:#1A1A1A;color:#F7F4EE;}\n.post-btn{background:#1B4D35;color:#FFFFFF;border:none;padding:0 24px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:background .15s;border-left:1px solid #2E2E2E;}\n.post-btn:hover{background:#2A6B4A;}\n.upload-btn{background:transparent;color:#A8A8A0;border:none;border-left:1px solid #2E2E2E;padding:0 16px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:color .15s;}\n.upload-btn:hover{color:#F7F4EE;}\n\n/* MAIN GRID */\n.main-grid{display:grid;grid-template-columns:1fr 360px;}\n.panels-section{border-right:4px solid #0D0D0D;padding:36px 40px;}\n.sec-hdr{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:24px;border-bottom:2px solid #0D0D0D;padding-bottom:12px;}\n.sec-title{font-family:'Playfair Display',serif;font-size:10px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:#0D0D0D;}\n.sec-sub{font-family:'DM Mono',monospace;font-size:10px;color:#6B6B6B;letter-spacing:1px;}\n\n/* PANEL GRID */\n.panel-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0;background:#0D0D0D;border:2px solid #0D0D0D;}\n.pc{background:#F7F4EE;padding:22px 18px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;border-right:1px solid #D8D5CE;border-bottom:1px solid #D8D5CE;}\n.pc:nth-child(3n){border-right:none;}\n.pc:nth-child(4),.pc:nth-child(5),.pc:nth-child(6){border-bottom:none;}\n.pc::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--pc);transform:scaleX(0);transition:transform .25s;transform-origin:left;}\n.pc:hover::after{transform:scaleX(1);}\n.pc:hover{background:#0D0D0D;}\n.pc:hover .pc-icon{color:var(--pc);}\n.pc:hover .pc-name{color:#F7F4EE;}\n.pc:hover .pc-count{color:#A8A8A0;}\n.pc-icon{font-size:16px;margin-bottom:10px;display:block;transition:color .2s;color:#A8A8A0;}\n.pc-name{font-family:'Playfair Display',serif;font-size:13px;font-weight:700;line-height:1.2;margin-bottom:5px;transition:color .2s;color:#0D0D0D;}\n.pc-count{font-family:'DM Mono',monospace;font-size:10px;color:#6B6B6B;letter-spacing:.5px;transition:color .2s;}\n\n/* JOURNAL SIDEBAR */\n.j-sidebar{padding:36px 28px;}\n.j-feed{display:flex;flex-direction:column;}\n.j-entry{padding:20px 0;border-bottom:1px solid #D8D5CE;}\n.j-entry:first-child{padding-top:0;}\n.j-meta{display:flex;align-items:center;gap:6px;margin-bottom:10px;flex-wrap:wrap;}\n.j-date{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;}\n.j-tag{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:2px 7px;color:#FFFFFF;}\n.j-badge{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:2px 7px;background:#D8D5CE;color:#6B6B6B;border:1px solid #A8A8A0;}\n.j-src{font-family:'DM Mono',monospace;font-size:9px;color:#A8A8A0;margin-bottom:8px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}\n.j-txt{font-family:'Playfair Display',serif;font-size:14px;line-height:1.65;color:#1A1A1A;}\n.j-takeaway{margin-top:10px;padding-top:10px;border-top:1px solid #D8D5CE;}\n.j-takeaway-lbl{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:#1B4D35;display:block;margin-bottom:4px;}\n.j-takeaway-txt{font-family:'Playfair Display',serif;font-size:13px;line-height:1.6;color:#1B4D35;font-style:italic;}\n.del-btn{margin-left:auto;background:none;border:none;cursor:pointer;color:#D8D5CE;font-size:12px;padding:2px 4px;transition:color .15s;flex-shrink:0;}\n.del-btn:hover{color:#8B2000;}\n.filter-bar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:18px;padding-bottom:14px;border-bottom:1px solid #D8D5CE;}\n.fb{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:4px 8px;border:1px solid #D8D5CE;background:none;cursor:pointer;color:#6B6B6B;transition:all .15s;}\n.fb:hover,.fb.on{background:#0D0D0D;color:#F7F4EE;border-color:#0D0D0D;}\n\n/* QUEUE PAGE */\n.queue-page{min-height:100vh;background:#F7F4EE;}\n.queue-hero{background:#0D0D0D;border-bottom:4px solid #1B4D35;padding:40px;}\n.queue-hero-top{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;}\n.queue-title{font-family:'Playfair Display',serif;font-size:clamp(40px,6vw,72px);font-weight:900;line-height:1;letter-spacing:-2px;color:#FFFFFF;}\n.queue-title em{color:#1B4D35;font-style:normal;}\n.queue-count{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#A8A8A0;}\n.queue-input-wrap{display:flex;gap:0;background:#1A1A1A;border:2px solid #2E2E2E;}\n.queue-input{flex:1;background:transparent;border:none;color:#F7F4EE;font-family:'Playfair Display',serif;font-size:18px;padding:16px 20px;outline:none;}\n.queue-input::placeholder{color:#3A3A3A;}\n.queue-url-inp{background:transparent;border:none;border-left:1px solid #2E2E2E;color:#A8A8A0;font-family:'DM Mono',monospace;font-size:10px;padding:0 16px;outline:none;width:200px;}\n.queue-url-inp::placeholder{color:#3A3A3A;}\n.queue-panel-sel{background:transparent;border:none;border-left:1px solid #2E2E2E;color:#A8A8A0;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:0 14px;outline:none;cursor:pointer;}\n.queue-panel-sel option{background:#1A1A1A;color:#F7F4EE;}\n.queue-add-btn{background:#1B4D35;color:#FFFFFF;border:none;padding:0 28px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;white-space:nowrap;transition:background .15s;}\n.queue-add-btn:hover{background:#2A6B4A;}\n.queue-body{padding:0;}\n.queue-tabs{display:flex;border-bottom:4px solid #0D0D0D;}\n.q-tab{flex:1;padding:14px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;border:none;background:none;cursor:pointer;color:#6B6B6B;border-right:1px solid #D8D5CE;transition:all .15s;}\n.q-tab:last-child{border-right:none;}\n.q-tab.on{background:#0D0D0D;color:#F7F4EE;}\n.queue-list{padding:0;}\n.q-item{padding:20px 40px;border-bottom:1px solid #D8D5CE;display:flex;align-items:flex-start;gap:16px;transition:background .15s;}\n.q-item:hover{background:#FFFFFF;}\n.q-item.done{opacity:.5;}\n.q-check{width:20px;height:20px;border:2px solid #D8D5CE;border-radius:50%;flex-shrink:0;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-top:2px;transition:all .15s;}\n.q-check:hover{border-color:#1B4D35;}\n.q-check.checked{background:#1B4D35;border-color:#1B4D35;color:#FFFFFF;font-size:10px;}\n.q-content{flex:1;min-width:0;}\n.q-title{font-family:'Playfair Display',serif;font-size:16px;font-weight:700;color:#0D0D0D;margin-bottom:4px;line-height:1.3;}\n.q-title.done{text-decoration:line-through;color:#A8A8A0;}\n.q-url{font-family:'DM Mono',monospace;font-size:9px;color:#A8A8A0;letter-spacing:.5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:400px;margin-bottom:6px;}\n.q-meta{display:flex;align-items:center;gap:8px;}\n.q-date{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;}\n.q-panel-tag{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:2px 7px;color:#FFFFFF;}\n.q-actions{display:flex;gap:8px;align-items:center;flex-shrink:0;}\n.q-file-btn{background:none;border:1px solid #D8D5CE;padding:5px 12px;font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;text-transform:uppercase;cursor:pointer;color:#6B6B6B;transition:all .15s;white-space:nowrap;}\n.q-file-btn:hover{border-color:#1B4D35;color:#1B4D35;}\n.q-del{background:none;border:none;cursor:pointer;color:#D8D5CE;font-size:14px;padding:2px 4px;transition:color .15s;}\n.q-del:hover{color:#8B2000;}\n.queue-empty{padding:80px 40px;text-align:center;}\n.queue-empty-icon{font-size:40px;margin-bottom:16px;opacity:.15;}\n.queue-empty-txt{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:#A8A8A0;margin-bottom:8px;}\n.queue-empty-sub{font-family:'DM Sans',sans-serif;font-size:14px;color:#A8A8A0;}\n\n/* FILE TO JOURNAL MODAL */\n.ftj-overlay{position:fixed;inset:0;background:rgba(13,13,13,.88);z-index:300;display:flex;align-items:center;justify-content:center;padding:24px;}\n.ftj-modal{background:#F7F4EE;width:100%;max-width:560px;border:3px solid #0D0D0D;}\n.ftj-hdr{padding:20px 24px;border-bottom:2px solid #0D0D0D;display:flex;align-items:baseline;justify-content:space-between;}\n.ftj-title{font-family:'Playfair Display',serif;font-size:22px;font-weight:900;color:#0D0D0D;}\n.ftj-close{background:none;border:none;font-size:20px;cursor:pointer;color:#6B6B6B;}\n.ftj-body{padding:24px;}\n.ftj-src{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;color:#A8A8A0;margin-bottom:16px;text-transform:uppercase;}\n.ftj-ta{width:100%;border:2px solid #D8D5CE;padding:14px;font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#0D0D0D;outline:none;resize:none;background:#FFFFFF;transition:border-color .15s;}\n.ftj-ta:focus{border-color:#0D0D0D;}\n.ftj-footer{padding:16px 24px;border-top:1px solid #D8D5CE;display:flex;gap:10px;justify-content:flex-end;}\n\n/* PANEL PAGE */\n.panel-page{min-height:100vh;background:#F7F4EE;}\n.pp-hero{border-bottom:4px solid #0D0D0D;display:grid;grid-template-columns:8px 1fr auto;}\n.pp-accent{background:var(--dc);}\n.pp-hero-body{padding:48px 40px;}\n.pp-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#6B6B6B;margin-bottom:12px;}\n.pp-title{font-family:'Playfair Display',serif;font-size:clamp(44px,7vw,80px);font-weight:900;line-height:1;letter-spacing:-3px;color:var(--dc);}\n.pp-count{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#6B6B6B;margin-top:14px;}\n.pp-back-col{border-left:4px solid #0D0D0D;display:flex;align-items:flex-start;padding:36px;}\n.pp-back{background:none;border:2px solid #0D0D0D;padding:10px 18px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all .15s;color:#0D0D0D;white-space:nowrap;}\n.pp-back:hover{background:#0D0D0D;color:#F7F4EE;}\n.pp-body{padding:40px;}\n.pp-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:0;background:#0D0D0D;border:2px solid #0D0D0D;}\n.pp-card{background:#F7F4EE;padding:28px;border-right:1px solid #D8D5CE;border-bottom:1px solid #D8D5CE;}\n.pp-card-meta{display:flex;align-items:center;gap:6px;margin-bottom:12px;flex-wrap:wrap;}\n.pp-card-date{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;}\n.pp-card-src{font-family:'DM Mono',monospace;font-size:9px;color:#6B6B6B;margin-bottom:10px;display:block;}\n.pp-card-txt{font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#1A1A1A;}\n.pp-card-takeaway{margin-top:14px;padding-top:14px;border-top:1px solid #D8D5CE;}\n.pp-card-takeaway-lbl{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:#1B4D35;display:block;margin-bottom:6px;}\n.pp-card-takeaway-txt{font-family:'Playfair Display',serif;font-size:14px;line-height:1.65;color:#1B4D35;font-style:italic;}\n.pp-empty{padding:100px 40px;text-align:center;}\n.pp-empty-icon{font-size:48px;margin-bottom:16px;opacity:.15;}\n.pp-empty-txt{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:#A8A8A0;margin-bottom:8px;}\n.pp-empty-sub{font-family:'DM Sans',sans-serif;font-size:14px;color:#A8A8A0;}\n\n/* JOURNAL PAGE */\n.journal-page{min-height:100vh;background:#F7F4EE;}\n.journal-hero{border-bottom:4px solid #0D0D0D;padding:44px 40px 36px;display:grid;grid-template-columns:1fr auto;gap:40px;align-items:end;}\n.journal-title{font-family:'Playfair Display',serif;font-size:clamp(44px,6vw,72px);font-weight:900;line-height:1;letter-spacing:-2px;color:#0D0D0D;}\n.journal-title em{color:#1B4D35;font-style:normal;}\n.journal-subtitle{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#6B6B6B;margin-top:10px;}\n.journal-hero-stats{display:flex;gap:28px;align-items:flex-end;}\n.jh-stat{text-align:right;}\n.jh-n{font-family:'Playfair Display',serif;font-size:36px;font-weight:900;line-height:1;color:#0D0D0D;}\n.jh-l{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#6B6B6B;margin-top:2px;}\n.journal-write{background:#1A1A1A;border-bottom:4px solid #1B4D35;padding:24px 40px;}\n.journal-write-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#1B4D35;margin-bottom:12px;}\n.journal-textarea{width:100%;background:transparent;border:none;border-bottom:2px solid #2E2E2E;color:#F7F4EE;font-family:'Playfair Display',serif;font-size:18px;line-height:1.6;padding:6px 0 14px;outline:none;resize:none;}\n.journal-textarea::placeholder{color:#3A3A3A;}\n.journal-textarea:focus{border-bottom-color:#1B4D35;}\n.journal-write-footer{display:flex;align-items:center;gap:12px;margin-top:12px;}\n.journal-body{display:grid;grid-template-columns:220px 1fr;}\n.journal-filters{border-right:4px solid #0D0D0D;padding:28px 20px;position:sticky;top:0;max-height:100vh;overflow-y:auto;background:#F7F4EE;}\n.jf-section{margin-bottom:24px;}\n.jf-label{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:#6B6B6B;margin-bottom:10px;display:block;}\n.jf-btn{display:block;width:100%;text-align:left;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:7px 10px;border:none;background:none;cursor:pointer;color:#6B6B6B;transition:all .15s;margin-bottom:2px;}\n.jf-btn:hover,.jf-btn.on{background:#0D0D0D;color:#F7F4EE;}\n.journal-feed{padding:0;}\n.day-group{border-bottom:4px solid #0D0D0D;}\n.day-header{padding:16px 40px;background:#0D0D0D;display:flex;align-items:baseline;gap:16px;position:sticky;top:0;z-index:10;}\n.day-date{font-family:'Playfair Display',serif;font-size:20px;font-weight:900;color:#FFFFFF;}\n.day-count{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;text-transform:uppercase;color:#A8A8A0;}\n.journal-entry{padding:28px 40px;border-bottom:1px solid #D8D5CE;transition:background .15s;}\n.journal-entry:hover{background:#FFFFFF;}\n.je-meta{display:flex;align-items:center;gap:8px;margin-bottom:12px;flex-wrap:wrap;}\n.je-time{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#A8A8A0;}\n.je-src{font-family:'DM Mono',monospace;font-size:9px;color:#6B6B6B;margin-bottom:10px;display:block;}\n.je-text{font-family:'Playfair Display',serif;font-size:17px;line-height:1.75;color:#1A1A1A;}\n.je-takeaway{margin-top:14px;padding-top:14px;border-top:1px solid #D8D5CE;}\n.je-takeaway-label{font-family:'DM Mono',monospace;font-size:8px;letter-spacing:2px;text-transform:uppercase;color:#1B4D35;margin-bottom:6px;display:block;}\n.je-takeaway-text{font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#1B4D35;font-style:italic;}\n.je-del{margin-left:auto;background:none;border:none;cursor:pointer;color:#D8D5CE;font-size:12px;padding:2px 4px;transition:color .15s;}\n.je-del:hover{color:#8B2000;}\n.journal-empty{padding:80px 40px;text-align:center;}\n.journal-empty-txt{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;color:#A8A8A0;margin-bottom:8px;}\n.journal-empty-sub{font-family:'DM Sans',sans-serif;font-size:14px;color:#A8A8A0;}\n\n/* SOURCES FOOTER */\n.sources{padding:36px 40px;border-top:4px solid #0D0D0D;background:#0D0D0D;}\n.src-label{font-family:'DM Mono',monospace;font-size:9px;font-weight:500;letter-spacing:3px;text-transform:uppercase;color:#1B4D35;margin-bottom:24px;display:flex;align-items:center;gap:12px;}\n.src-label::after{content:'';flex:1;height:1px;background:#2E2E2E;}\n.src-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0;border:1px solid #2E2E2E;}\n.src-item{padding:20px 24px;border-right:1px solid #2E2E2E;}\n.src-item:nth-child(3n){border-right:none;}\n.src-item:nth-child(n+4){border-top:1px solid #2E2E2E;}\n.src-name{font-family:'Playfair Display',serif;font-weight:700;font-size:15px;margin-bottom:4px;color:#FFFFFF;}\n.src-desc{font-family:'DM Sans',sans-serif;font-size:12px;color:#A8A8A0;line-height:1.5;margin-bottom:10px;}\n.src-link{font-family:'DM Mono',monospace;font-size:9px;color:#1B4D35;letter-spacing:1px;text-transform:uppercase;text-decoration:none;cursor:pointer;transition:color .15s;}\n.src-link:hover{color:#F7F4EE;}\n\n/* SAVE TOAST */\n.save-toast{position:fixed;bottom:24px;right:24px;background:#1B4D35;color:#FFFFFF;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;padding:10px 18px;z-index:400;opacity:0;transition:opacity .3s;border-left:3px solid #2A6B4A;}\n.save-toast.show{opacity:1;}\n\n/* ADD MODAL */\n.overlay{position:fixed;inset:0;background:rgba(13,13,13,.88);z-index:200;display:flex;align-items:center;justify-content:center;padding:24px;}\n.modal{background:#F7F4EE;width:100%;max-width:640px;max-height:90vh;overflow-y:auto;border:3px solid #0D0D0D;display:flex;flex-direction:column;}\n.m-hdr{padding:22px 28px 18px;border-bottom:3px solid #0D0D0D;display:flex;align-items:baseline;justify-content:space-between;flex-shrink:0;}\n.m-title{font-family:'Playfair Display',serif;font-size:24px;font-weight:900;color:#0D0D0D;}\n.m-close{background:none;border:none;font-size:22px;cursor:pointer;color:#6B6B6B;line-height:1;}\n.m-body{padding:28px;flex:1;}\n.m-footer{padding:18px 28px;border-top:1px solid #D8D5CE;display:flex;gap:12px;justify-content:flex-end;flex-shrink:0;background:#F7F4EE;}\n.m-label{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#6B6B6B;margin-bottom:10px;display:block;}\n.m-sec{margin-bottom:22px;}\n.tabs{display:flex;border:2px solid #0D0D0D;margin-bottom:20px;}\n.tab{flex:1;padding:11px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;border:none;background:none;cursor:pointer;color:#6B6B6B;border-right:1px solid #D8D5CE;transition:all .15s;}\n.tab:last-child{border-right:none;}\n.tab.on{background:#0D0D0D;color:#F7F4EE;}\n.dz{border:2px dashed #D8D5CE;padding:44px 24px;text-align:center;cursor:pointer;transition:all .2s;background:#FFFFFF;}\n.dz:hover,.dz.drag{border-color:#1B4D35;background:#EDF4F0;}\n.dz-icon{font-size:32px;margin-bottom:10px;}\n.dz-main{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;margin-bottom:6px;color:#0D0D0D;}\n.dz-sub{font-size:13px;color:#6B6B6B;}\n.url-inp{width:100%;border:2px solid #D8D5CE;padding:12px 16px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;background:#FFFFFF;transition:border-color .15s;color:#0D0D0D;}\n.url-inp:focus{border-color:#0D0D0D;}\n.url-note{font-family:'DM Mono',monospace;font-size:9px;color:#A8A8A0;letter-spacing:1px;margin-top:8px;line-height:1.5;}\n.processing{text-align:center;padding:48px 24px;}\n.spinner{width:40px;height:40px;border:3px solid #D8D5CE;border-top-color:#1B4D35;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 18px;}\n@keyframes spin{to{transform:rotate(360deg);}}\n.proc-title{font-family:'Playfair Display',serif;font-size:20px;font-weight:700;margin-bottom:8px;color:#0D0D0D;}\n.proc-step{font-family:'DM Mono',monospace;font-size:11px;letter-spacing:1px;color:#1B4D35;margin-bottom:6px;}\n.ai-banner{background:#EDF4F0;border:1px solid #A8CABB;padding:10px 14px;margin-bottom:20px;display:flex;gap:8px;align-items:center;}\n.ai-banner-txt{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#1B4D35;}\n.sum-box{background:#FFFFFF;border:2px solid #D8D5CE;padding:18px;}\n.sum-lbl{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:#1B4D35;margin-bottom:10px;display:block;}\n.sum-ta{width:100%;border:none;outline:none;font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#1A1A1A;resize:none;background:transparent;}\n.title-inp{width:100%;border:2px solid #D8D5CE;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:14px;outline:none;background:#FFFFFF;transition:border-color .15s;color:#0D0D0D;}\n.title-inp:focus{border-color:#0D0D0D;}\n.panel-picker{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;}\n.ppc{border:2px solid #D8D5CE;padding:10px 8px;cursor:pointer;transition:all .15s;text-align:center;background:#FFFFFF;position:relative;}\n.ppc:hover{border-color:#A8A8A0;}\n.ppc.on{border-color:var(--ppc);background:var(--ppc);}\n.ppc.on .ppc-icon,.ppc.on .ppc-lbl{color:#FFFFFF;}\n.ppc-icon{font-size:15px;display:block;margin-bottom:4px;transition:color .15s;color:#6B6B6B;}\n.ppc-lbl{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:.5px;text-transform:uppercase;color:#6B6B6B;line-height:1.2;transition:color .15s;}\n.ppc-check{position:absolute;top:4px;right:4px;width:14px;height:14px;background:#FFFFFF;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:8px;color:var(--ppc);font-weight:900;}\n.ai-sug{font-family:'DM Mono',monospace;font-size:10px;color:#6B6B6B;letter-spacing:1px;margin-top:8px;}\n.ai-sug span{color:#1B4D35;}\n.btn-ghost{background:none;border:2px solid #D8D5CE;padding:10px 20px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;color:#6B6B6B;transition:all .15s;}\n.btn-ghost:hover{border-color:#0D0D0D;color:#0D0D0D;}\n.btn-solid{background:#0D0D0D;color:#FFFFFF;border:none;padding:10px 24px;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:background .15s;}\n.btn-solid:hover{background:#1B4D35;}\n.btn-solid:disabled{opacity:.35;pointer-events:none;}\n.err-box{background:#FDF0EE;border:1px solid #E8B4A8;padding:12px 16px;font-family:'DM Sans',sans-serif;font-size:13px;color:#8B2000;margin-bottom:16px;}\n.takeaway-inp{width:100%;border:2px solid #D8D5CE;padding:14px 16px;background:#FFFFFF;font-family:'Playfair Display',serif;font-size:15px;line-height:1.7;color:#1A1A1A;resize:none;outline:none;transition:border-color .2s;display:block;}\n.takeaway-inp:focus{border-color:#0D0D0D;}\n.takeaway-inp.nudge{border-color:#1B4D35;}\n.nudge-msg{font-family:'DM Mono',monospace;font-size:9px;letter-spacing:1px;color:#1B4D35;text-transform:uppercase;margin-top:6px;}\n\n@media(max-width:768px){\n  .nav{padding:0 16px;}\n  .nav-wm{font-size:18px;letter-spacing:6px;padding-right:16px;}\n  .nav-link{padding:0 12px;font-size:9px;}\n  .masthead{padding:8px 16px;}\n  .masthead-c{display:none;}\n  .reading-now{grid-template-columns:1fr;}\n  .rn-label-col{padding:16px;flex-direction:row;align-items:center;gap:12px;}\n  .rn-body{padding:16px;}\n  .write-bar{padding:0 16px;}\n  .main-grid{grid-template-columns:1fr;}\n  .panels-section{border-right:none;border-bottom:4px solid #0D0D0D;padding:24px 16px;}\n  .j-sidebar{padding:24px 16px;}\n  .queue-hero{padding:24px 16px;}\n  .queue-input-wrap{flex-direction:column;}\n  .queue-url-inp{width:100%;border-left:none;border-top:1px solid #2E2E2E;padding:12px 16px;}\n  .queue-panel-sel{border-left:none;border-top:1px solid #2E2E2E;padding:12px 16px;}\n  .queue-add-btn{padding:14px;width:100%;}\n  .q-item{padding:16px;}\n  .journal-body{grid-template-columns:1fr;}\n  .journal-filters{display:none;}\n  .journal-entry{padding:20px 16px;}\n  .day-header{padding:12px 16px;}\n  .pp-hero{grid-template-columns:6px 1fr;}\n  .pp-back-col{display:none;}\n  .pp-body{padding:20px 16px;}\n  .sources{padding:24px 16px;}\n  .src-grid{grid-template-columns:1fr;}\n  .src-item{border-right:none !important;border-bottom:1px solid #2E2E2E;}\n}\n";

// â”€â”€ Main Component â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const __st = {
  get: async (k) => {
    if (window.storage && typeof window.storage.get === "function")
      try { return await window.storage.get(k); } catch(e) {}
    try { const v = localStorage.getItem(k); return v ? { value: v } : null; } catch { return null; }
  },
  set: async (k, v) => {
    if (window.storage && typeof window.storage.set === "function")
      try { return await window.storage.set(k, v); } catch(e) {}
    try { localStorage.setItem(k, v); return { key: k, value: v }; } catch { return null; }
  },
};

function Pangea() {
  const [entries,  setEntries]  = useState([]);
  const [queue,    setQueue]    = useState([]);
  const [books,    setBooks]    = useState([]);
  const [loaded,   setLoaded]   = useState(false);
  const [view,     setView]     = useState("home");
  const [activePanelId, setActivePanelId] = useState(null);

  // Home write bar
  const [writeText,  setWriteText]  = useState("");
  const [writePanel, setWritePanel] = useState("");

  // Journal page
  const [jFilter,  setJFilter]  = useState("all");
  const [jPanel,   setJPanel]   = useState(null);
  const [jWriting, setJWriting] = useState("");
  const [jWritePanel, setJWritePanel] = useState("");

  // Queue page
  const [qInput,    setQInput]    = useState("");
  const [qUrl,      setQUrl]      = useState("");
  const [qPanel,    setQPanel]    = useState("");
  const [qTab,      setQTab]      = useState("pending");
  const [ftjItem,   setFtjItem]   = useState(null);
  const [ftjNote,   setFtjNote]   = useState("");
  const [ftjPanel,  setFtjPanel]  = useState("");

  // Reading Now
  const [addingBook,    setAddingBook]    = useState(false);
  const [bookTitle,     setBookTitle]     = useState("");
  const [bookAuthor,    setBookAuthor]    = useState("");

  // Search & filter
  const [searchQ,     setSearchQ]     = useState("");
  const [filterPanel, setFilterPanel] = useState(null);

  // Add modal
  const [showModal,  setShowModal]  = useState(false);
  const [tab,        setTab]        = useState("file");
  const [stage,      setStage]      = useState("input");
  const [procStep,   setProcStep]   = useState("");
  const [dragOver,   setDragOver]   = useState(false);
  const [chosenFile, setChosenFile] = useState(null);
  const [urlVal,     setUrlVal]     = useState("");
  const [editSum,    setEditSum]    = useState("");
  const [editTitle,  setEditTitle]  = useState("");
  const [editPanels, setEditPanels] = useState([]);
  const [aiPanels,   setAiPanels]   = useState([]);
  const [editTakeaway,    setEditTakeaway]    = useState("");
  const [nudgeTakeaway,   setNudgeTakeaway]   = useState(false);
  const [aiType,     setAiType]     = useState("");
  const [apiError,   setApiError]   = useState("");

  // Toast
  const [showSaved, setShowSaved] = useState(false);

  const fileRef = useRef();

  // â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  useEffect(() => {
    async function load() {
      try {
        const [re, rq, rb] = await Promise.all([
          __st.get(STORAGE_KEYS.entries),
          __st.get(STORAGE_KEYS.queue),
          __st.get(STORAGE_KEYS.books),
        ]);
        setEntries(re ? JSON.parse(re.value) : []);
        setQueue(rq   ? JSON.parse(rq.value)  : []);
        setBooks(rb   ? JSON.parse(rb.value)  : []);
      } catch { setEntries([]); setQueue([]); setBooks([]); }
      setLoaded(false);
      // small delay so React finishes
      setTimeout(() => setLoaded(true), 50);
    }
    load();
  }, []);

  // â”€â”€ Persist â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const toast = () => { setShowSaved(true); setTimeout(() => setShowSaved(false), 1800); };

  const saveEntries = (next) => { setEntries(next); __st.set(STORAGE_KEYS.entries, JSON.stringify(next)); toast(); };
  const saveQueue   = (next) => { setQueue(next);   __st.set(STORAGE_KEYS.queue,   JSON.stringify(next)); toast(); };
  const saveBooks   = (next) => { setBooks(next);   __st.set(STORAGE_KEYS.books,   JSON.stringify(next)); toast(); };

  const addEntry  = (e) => saveEntries([e, ...entries]);
  const delEntry  = (id) => saveEntries(entries.filter(e => e.id !== id));
  const addQueue  = (q) => saveQueue([q, ...queue]);
  const delQueue  = (id) => saveQueue(queue.filter(q => q.id !== id));
  const toggleDone = (id) => saveQueue(queue.map(q => q.id === id ? {...q, done: !q.done} : q));

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const getPD = (id) => PANELS.find(p => p.id === id);
  const today = new Date().toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"}).toUpperCase();

  // This week
  const MONTHS = {JAN:0,FEB:1,MAR:2,APR:3,MAY:4,JUN:5,JUL:6,AUG:7,SEP:8,OCT:9,NOV:10,DEC:11};
  const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
  const thisWeek = entries.filter(e => {
    try { const [m,d] = e.date.split(" "); return new Date(new Date().getFullYear(), MONTHS[m]??0, parseInt(d)) >= oneWeekAgo; }
    catch { return false; }
  }).length;

  // Post note
  const postNote = (text, panel, cb) => {
    if (!text.trim()) return;
    addEntry({id:Date.now(), ...ts(), panels:panel?[panel]:[], type:"note", text:text.trim()});
    cb();
  };

  // â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const closeModal = () => {
    setShowModal(false); setStage("input"); setChosenFile(null); setUrlVal("");
    setEditSum(""); setEditTitle(""); setEditPanels([]); setAiPanels([]);
    setEditTakeaway(""); setNudgeTakeaway(false); setAiType(""); setApiError(""); setProcStep("");
  };
  const togglePP = (id) => setEditPanels(p => p.includes(id) ? p.filter(x=>x!==id) : [...p, id]);
  const getType  = () => { if(tab==="url")return"url"; if(tab==="image")return"image"; if(!chosenFile)return"pdf"; return chosenFile.name.toLowerCase().includes("slide")||chosenFile.name.toLowerCase().includes("lecture")?"slides":"pdf"; };

  const analyze = async () => {
    const type = getType(); setAiType(type); setStage("processing"); setApiError("");
    try {
      setProcStep("Reading contentâ€¦"); await new Promise(r=>setTimeout(r,400));
      setProcStep("Extracting key ideasâ€¦");
      const result = await analyzeWithClaude(tab, chosenFile, urlVal);
      setProcStep("Done.");
      setEditTitle(result.title || chosenFile?.name || urlVal);
      setEditSum(result.summary || "");
      const sug = Array.isArray(result.suggestedPanels) ? result.suggestedPanels : (result.suggestedPanel?[result.suggestedPanel]:[]);
      setAiPanels(sug); setEditPanels(sug); setStage("review");
    } catch(err) { setApiError(err.message || "Something went wrong."); setStage("input"); }
  };

  const saveUpload = () => {
    if (!editTakeaway.trim()) { setNudgeTakeaway(true); return; }
    addEntry({id:Date.now(), ...ts(), panels:editPanels, type:"upload", sourceType:aiType, sourceTitle:editTitle, text:editSum.trim(), takeaway:editTakeaway.trim()});
    closeModal();
  };
  const saveUploadAnyway = () => {
    addEntry({id:Date.now(), ...ts(), panels:editPanels, type:"upload", sourceType:aiType, sourceTitle:editTitle, text:editSum.trim(), takeaway:""});
    closeModal();
  };

  // â”€â”€ Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const searchResults = searchQ.trim().length > 1
    ? entries.filter(e => { const q = searchQ.toLowerCase(); return e.text.toLowerCase().includes(q)||(e.sourceTitle||"").toLowerCase().includes(q)||(e.panels||[]).some(pid=>(getPD(pid)?.label||"").toLowerCase().includes(q)); })
    : [];

  // â”€â”€ Shared Nav â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function Nav({ current }) {
    return (
      <nav className="nav">
        <div className="nav-wm" onClick={()=>{ setView("home"); setActivePanelId(null); }}>
          PAN<span className="nav-wm-g">G</span>EA
        </div>
        <div className="nav-links">
          <button className={`nav-link ${current==="home"?"active":""}`}    onClick={()=>{ setView("home"); setActivePanelId(null); }}>Home</button>
          <button className={`nav-link ${current==="queue"?"active":""}`}   onClick={()=>setView("queue")}>Queue</button>
          <button className={`nav-link ${current==="journal"?"active":""}`} onClick={()=>setView("journal")}>Journal</button>
          <button className="nav-link nav-add" onClick={()=>setShowModal(true)}>+ Add</button>
        </div>
      </nav>
    );
  }

  function Masthead({ right }) {
    return (
      <div className="masthead">
        <span className="masthead-l">{today}</span>
        <span className="masthead-c">&#8220;{MOTTO}&#8221;</span>
        <span className="masthead-r">{right}</span>
      </div>
    );
  }

  // â”€â”€ Entry card (shared) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function EntryCard({ entry, large = false }) {
    const panels = (entry.panels||[]).map(id=>getPD(id)).filter(Boolean);
    const sz = large ? 17 : 14;
    return (
      <div>
        <div className="j-meta">
          <span className="j-date">{entry.date} Â· {entry.time}</span>
          {panels.map(pd=><span key={pd.id} className="j-tag" style={{background:pd.color}}>{pd.label}</span>)}
          {entry.sourceType&&<span className="j-badge">{badgeMap[entry.sourceType]}</span>}
          <button className="del-btn" onClick={()=>delEntry(entry.id)}>âœ•</button>
        </div>
        {entry.sourceTitle&&<span className="j-src">â†³ {entry.sourceTitle}</span>}
        <div className="j-txt" style={{fontSize:sz}}>{entry.text}</div>
        {entry.takeaway&&(
          <div className="j-takeaway">
            <span className="j-takeaway-lbl">Your takeaway</span>
            <div className="j-takeaway-txt">{entry.takeaway}</div>
          </div>
        )}
      </div>
    );
  }

  // â”€â”€ Add Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderModal() {
    return (
      <div className="overlay" onClick={e=>e.target===e.currentTarget&&closeModal()}>
        <div className="modal">
          <div className="m-hdr">
            <span className="m-title">{stage==="input"?"Add to Pangea":stage==="processing"?"Analyzingâ€¦":"Review & File"}</span>
            <button className="m-close" onClick={closeModal}>âœ•</button>
          </div>
          {stage==="input"&&<>
            <div className="m-body">
              {apiError&&<div className="err-box">âš  {apiError}</div>}
              <div className="tabs">
                {[["file","ðŸ“„ PDF / Slides"],["image","ðŸ“¸ Image"],["url","ðŸ”— URL"]].map(([id,lbl])=>(
                  <button key={id} className={`tab ${tab===id?"on":""}`} onClick={()=>{setTab(id);setChosenFile(null);setUrlVal("");}}>
                    {lbl}
                  </button>
                ))}
              </div>
              {(tab==="file"||tab==="image")&&(
                <div className={`dz ${dragOver?"drag":""}`}
                  onClick={()=>fileRef.current?.click()}
                  onDragOver={e=>{e.preventDefault();setDragOver(true);}}
                  onDragLeave={()=>setDragOver(false)}
                  onDrop={e=>{e.preventDefault();setDragOver(false);setChosenFile(e.dataTransfer.files[0]);}}>
                  <div className="dz-icon">{tab==="image"?"ðŸ“¸":"ðŸ“„"}</div>
                  <div className="dz-main">{chosenFile?chosenFile.name:tab==="image"?"Drop an image":"Drop a PDF here"}</div>
                  <div className="dz-sub">{chosenFile?"Ready â€” click Analyze":"or click to browse"}</div>
                  <input ref={fileRef} type="file" accept={tab==="image"?"image/*":".pdf"} style={{display:"none"}} onChange={e=>setChosenFile(e.target.files[0])} />
                </div>
              )}
              {tab==="url"&&(
                <div className="m-sec">
                  <span className="m-label">Paste a URL</span>
                  <input className="url-inp" placeholder="https://â€¦" value={urlVal} onChange={e=>setUrlVal(e.target.value)} onKeyDown={e=>e.key==="Enter"&&urlVal.trim()&&analyze()} />
                  <div className="url-note">Note: AI will attempt to summarize based on the URL. For best results, paste article text directly as a note instead.</div>
                </div>
              )}
            </div>
            <div className="m-footer">
              <button className="btn-ghost" onClick={closeModal}>Cancel</button>
              <button className="btn-solid" onClick={analyze} disabled={!((tab==="file"&&chosenFile)||(tab==="image"&&chosenFile)||(tab==="url"&&urlVal.trim()))}>Analyze â†’</button>
            </div>
          </>}
          {stage==="processing"&&(
            <div className="m-body">
              <div className="processing">
                <div className="spinner"></div>
                <div className="proc-step">{procStep}</div>
                <div className="proc-title">Claude is reading your content</div>
              </div>
            </div>
          )}
          {stage==="review"&&<>
            <div className="m-body">
              <div className="ai-banner"><span>âœ¦</span><span className="ai-banner-txt">AI summary â€” edit freely</span></div>
              <div className="m-sec">
                <span className="m-label">Source title</span>
                <input className="title-inp" value={editTitle} onChange={e=>setEditTitle(e.target.value)} placeholder="What is this from?" />
              </div>
              <div className="m-sec">
                <span className="m-label">Summary</span>
                <div className="sum-box">
                  <span className="sum-lbl">âœ¦ AI Draft</span>
                  <textarea className="sum-ta" value={editSum} onChange={e=>setEditSum(e.target.value)} rows={5} />
                </div>
              </div>
              <div className="m-sec">
                <span className="m-label">File to panels</span>
                <div className="panel-picker">
                  {PANELS.map(p => { const on = editPanels.includes(p.id); return (
                    <div key={p.id} className={`ppc ${on?"on":""}`} style={{"--ppc":p.color}} onClick={()=>togglePP(p.id)}>
                      <span className="ppc-icon">{p.icon}</span>
                      <span className="ppc-lbl">{p.label}</span>
                      {on&&<span className="ppc-check">âœ“</span>}
                    </div>
                  ); })}
                </div>
                {aiPanels.length>0&&(
                  <div className="ai-sug">AI suggested: <span>{aiPanels.map(id=>getPD(id)).filter(Boolean).map(p=>`${p.icon} ${p.label}`).join(", ")}</span>
                    {JSON.stringify([...aiPanels].sort())!==JSON.stringify([...editPanels].sort())&&
                      <button onClick={()=>setEditPanels(aiPanels)} style={{marginLeft:10,fontFamily:"DM Mono,monospace",fontSize:10,letterSpacing:1,background:"none",border:"none",color:"#1B4D35",cursor:"pointer",textTransform:"uppercase"}}>Use â†’</button>
                    }
                  </div>
                )}
              </div>
              <div className="m-sec">
                <span className="m-label">Your takeaway <span style={{color:"#A8A8A0",letterSpacing:0,textTransform:"none",fontSize:10}}>â€” optional but encouraged</span></span>
                <textarea
                  className={`takeaway-inp ${nudgeTakeaway?"nudge":""}`}
                  placeholder="What's your takeaway?"
                  value={editTakeaway}
                  onChange={e=>{setEditTakeaway(e.target.value);setNudgeTakeaway(false);}}
                  rows={3}
                />
                {nudgeTakeaway&&<div className="nudge-msg">âœ¦ Take a moment â€” what did this mean to you?</div>}
              </div>
            </div>
            <div className="m-footer">
              <button className="btn-ghost" onClick={()=>{setStage("input");setApiError("");}}>â† Back</button>
              {nudgeTakeaway&&<button className="btn-ghost" onClick={saveUploadAnyway} style={{fontSize:9}}>Skip â†’</button>}
              <button className="btn-solid" onClick={saveUpload}>Save to Pangea â†’</button>
            </div>
          </>}
        </div>
      </div>
    );
  }

  if (!loaded) return (
    <div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"100vh",fontFamily:"DM Mono,monospace",fontSize:12,letterSpacing:3,color:"#6B6B6B",background:"#F7F4EE",textTransform:"uppercase"}}>
      Loadingâ€¦
    </div>
  );

  // â”€â”€ PANEL PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (view === "panel" && activePanelId) {
    const p = getPD(activePanelId);
    const panelEntries = entries.filter(e => (e.panels||[]).includes(activePanelId));
    return (
      <div className="panel-page" style={{fontFamily:"DM Sans,sans-serif",color:"#0D0D0D"}}>
        <style>{CSS}</style>
        <div className={`save-toast ${showSaved?"show":""}`}>âœ“ Saved</div>
        {showModal&&renderModal()}
        <Nav current="" />
        <Masthead right={p.label} />
        <div className="pp-hero" style={{"--dc":p.color}}>
          <div className="pp-accent"></div>
          <div className="pp-hero-body">
            <div className="pp-label">Panel</div>
            <div className="pp-title">{p.label}</div>
            <div className="pp-count">{panelEntries.length} {panelEntries.length===1?"entry":"entries"}</div>
          </div>
          <div className="pp-back-col">
            <button className="pp-back" onClick={()=>{ setView("home"); setActivePanelId(null); }}>â† Back</button>
          </div>
        </div>
        {panelEntries.length===0 ? (
          <div className="pp-empty">
            <div className="pp-empty-icon">{p.icon}</div>
            <div className="pp-empty-txt">Nothing filed here yet</div>
            <div className="pp-empty-sub">Add a note or upload something and tag it to {p.label}</div>
          </div>
        ) : (
          <div className="pp-body">
            <div className="pp-grid">
              {panelEntries.map(entry => {
                const others = (entry.panels||[]).filter(pid=>pid!==activePanelId).map(pid=>getPD(pid)).filter(Boolean);
                return (
                  <div key={entry.id} className="pp-card">
                    <div className="pp-card-meta">
                      <span className="pp-card-date">{entry.date} Â· {entry.time}</span>
                      {entry.sourceType&&<span className="j-badge">{badgeMap[entry.sourceType]}</span>}
                      {others.map(op=><span key={op.id} className="j-tag" style={{background:op.color}}>{op.label}</span>)}
                    </div>
                    {entry.sourceTitle&&<span className="pp-card-src">â†³ {entry.sourceTitle}</span>}
                    <div className="pp-card-txt">{entry.text}</div>
                    {entry.takeaway&&(
                      <div className="pp-card-takeaway">
                        <span className="pp-card-takeaway-lbl">Your takeaway</span>
                        <div className="pp-card-takeaway-txt">{entry.takeaway}</div>
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        )}
      </div>
    );
  }

  // â”€â”€ QUEUE PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (view === "queue") {
    const pending   = queue.filter(q => !q.done);
    const completed = queue.filter(q => q.done);
    const displayed = qTab === "pending" ? pending : completed;

    const addToQueue = () => {
      if (!qInput.trim()) return;
      addQueue({ id:Date.now(), ...ts(), title:qInput.trim(), url:qUrl.trim(), panel:qPanel, done:false });
      setQInput(""); setQUrl(""); setQPanel("");
    };

    const fileToJournal = (item) => {
      setFtjItem(item);
      setFtjNote(item.title);
      setFtjPanel(item.panel || "");
    };

    const saveFtj = () => {
      if (!ftjNote.trim()) return;
      addEntry({ id:Date.now(), ...ts(), panels:ftjPanel?[ftjPanel]:[], type:"note", text:ftjNote.trim() });
      toggleDone(ftjItem.id);
      setFtjItem(null); setFtjNote(""); setFtjPanel("");
    };

    return (
      <div className="queue-page" style={{fontFamily:"DM Sans,sans-serif",color:"#0D0D0D"}}>
        <style>{CSS}</style>
        <div className={`save-toast ${showSaved?"show":""}`}>âœ“ Saved</div>
        {showModal&&renderModal()}
        {ftjItem&&(
          <div className="ftj-overlay" onClick={e=>e.target===e.currentTarget&&setFtjItem(null)}>
            <div className="ftj-modal">
              <div className="ftj-hdr">
                <span className="ftj-title">File to Journal</span>
                <button className="ftj-close" onClick={()=>setFtjItem(null)}>âœ•</button>
              </div>
              <div className="ftj-body">
                <div className="ftj-src">From queue: {ftjItem.title}</div>
                <span className="m-label" style={{marginBottom:8,display:"block"}}>Your note</span>
                <textarea className="ftj-ta" value={ftjNote} onChange={e=>setFtjNote(e.target.value)} rows={5} placeholder="What did you take from this?" />
                <div style={{marginTop:16}}>
                  <span className="m-label" style={{marginBottom:8,display:"block"}}>Panel</span>
                  <select className="write-sel" style={{border:"2px solid #D8D5CE",padding:"8px 12px",color:"#0D0D0D",background:"#FFFFFF",width:"100%"}} value={ftjPanel} onChange={e=>setFtjPanel(e.target.value)}>
                    <option value="">No panel</option>
                    {PANELS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
                  </select>
                </div>
              </div>
              <div className="ftj-footer">
                <button className="btn-ghost" onClick={()=>setFtjItem(null)}>Cancel</button>
                <button className="btn-solid" onClick={saveFtj}>Save to Journal â†’</button>
              </div>
            </div>
          </div>
        )}
        <Nav current="queue" />
        <Masthead right="Queue" />
        <div className="queue-hero">
          <div className="queue-hero-top">
            <div className="queue-title">My <em>Queue</em></div>
            <div className="queue-count">{pending.length} pending Â· {completed.length} done</div>
          </div>
          <div className="queue-input-wrap">
            <input className="queue-input" placeholder="What do you want to read or look up?" value={qInput} onChange={e=>setQInput(e.target.value)} onKeyDown={e=>e.key==="Enter"&&addToQueue()} />
            <input className="queue-url-inp" placeholder="URL (optional)" value={qUrl} onChange={e=>setQUrl(e.target.value)} />
            <select className="queue-panel-sel" value={qPanel} onChange={e=>setQPanel(e.target.value)}>
              <option value="">Panelâ€¦</option>
              {PANELS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
            </select>
            <button className="queue-add-btn" onClick={addToQueue}>Add â†’</button>
          </div>
        </div>
        <div className="queue-tabs">
          <button className={`q-tab ${qTab==="pending"?"on":""}`} onClick={()=>setQTab("pending")}>Pending ({pending.length})</button>
          <button className={`q-tab ${qTab==="done"?"on":""}`}    onClick={()=>setQTab("done")}>Done ({completed.length})</button>
        </div>
        <div className="queue-list">
          {displayed.length===0 ? (
            <div className="queue-empty">
              <div className="queue-empty-icon">â—»</div>
              <div className="queue-empty-txt">{qTab==="pending"?"Queue is clear":"Nothing done yet"}</div>
              <div className="queue-empty-sub">{qTab==="pending"?"Add something to read or look up":"Complete items will appear here"}</div>
            </div>
          ) : displayed.map(item => {
            const pd = item.panel ? getPD(item.panel) : null;
            return (
              <div key={item.id} className={`q-item ${item.done?"done":""}`}>
                <div className={`q-check ${item.done?"checked":""}`} onClick={()=>toggleDone(item.id)}>
                  {item.done&&"âœ“"}
                </div>
                <div className="q-content">
                  <div className={`q-title ${item.done?"done":""}`}>{item.title}</div>
                  {item.url&&<div className="q-url">{item.url}</div>}
                  <div className="q-meta">
                    <span className="q-date">{item.date}</span>
                    {pd&&<span className="q-panel-tag" style={{background:pd.color}}>{pd.label}</span>}
                  </div>
                </div>
                <div className="q-actions">
                  {item.done&&<button className="q-file-btn" onClick={()=>fileToJournal(item)}>â†’ Journal</button>}
                  {!item.done&&item.url&&<a href={item.url} target="_blank" rel="noreferrer" className="q-file-btn">Open â†’</a>}
                  {!item.done&&<button className="q-file-btn" onClick={()=>toggleDone(item.id)}>Done âœ“</button>}
                  <button className="q-del" onClick={()=>delQueue(item.id)}>âœ•</button>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  }

  // â”€â”€ JOURNAL PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (view === "journal") {
    let jEntries = [...entries];
    if (jFilter==="notes")   jEntries = jEntries.filter(e=>e.type==="note");
    if (jFilter==="uploads") jEntries = jEntries.filter(e=>e.type==="upload");
    if (jPanel) jEntries = jEntries.filter(e=>(e.panels||[]).includes(jPanel));

    const groups = [];
    const seen = {};
    jEntries.forEach(e => {
      if (!seen[e.date]) { seen[e.date] = []; groups.push({ date:e.date, entries:seen[e.date] }); }
      seen[e.date].push(e);
    });

    return (
      <div className="journal-page" style={{fontFamily:"DM Sans,sans-serif",color:"#0D0D0D"}}>
        <style>{CSS}</style>
        <div className={`save-toast ${showSaved?"show":""}`}>âœ“ Saved</div>
        {showModal&&renderModal()}
        <Nav current="journal" />
        <Masthead right="Journal" />
        <div className="journal-hero">
          <div>
            <div className="journal-title">Your <em>Journal</em></div>
            <div className="journal-subtitle">{entries.length} {entries.length===1?"entry":"entries"} across {PANELS.length} panels</div>
          </div>
          <div className="journal-hero-stats">
            <div className="jh-stat">
              <div className="jh-n">{entries.filter(e=>e.type==="note").length}</div>
              <div className="jh-l">Notes</div>
            </div>
            <div className="jh-stat">
              <div className="jh-n">{entries.filter(e=>e.type==="upload").length}</div>
              <div className="jh-l">Uploads</div>
            </div>
            <div className="jh-stat">
              <div className="jh-n">{thisWeek}</div>
              <div className="jh-l">This week</div>
            </div>
          </div>
        </div>
        <div className="journal-write">
          <div className="journal-write-label">Write</div>
          <textarea className="journal-textarea" placeholder="What's on your mind?" value={jWriting} rows={3}
            onChange={e=>setJWriting(e.target.value)}
            onKeyDown={e=>{ if(e.key==="Enter"&&(e.metaKey||e.ctrlKey)) postNote(jWriting,jWritePanel,()=>{setJWriting("");setJWritePanel("");}); }} />
          <div className="journal-write-footer">
            <select className="write-sel" style={{border:"1px solid #2E2E2E"}} value={jWritePanel} onChange={e=>setJWritePanel(e.target.value)}>
              <option value="">Tag panel...</option>
              {PANELS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
            </select>
            <span style={{fontFamily:"DM Mono,monospace",fontSize:9,color:"#6B6B6B",letterSpacing:1}}>âŒ˜+Enter to post</span>
            <button className="post-btn" style={{marginLeft:"auto"}} onClick={()=>postNote(jWriting,jWritePanel,()=>{setJWriting("");setJWritePanel("");})}>Post â†’</button>
            <button className="upload-btn" onClick={()=>setShowModal(true)}>â†‘ Upload</button>
          </div>
        </div>
        <div className="journal-body">
          <div className="journal-filters">
            <div className="jf-section">
              <span className="jf-label">Type</span>
              {[["all","All"],["notes","Notes"],["uploads","Uploads"]].map(([val,lbl])=>(
                <button key={val} className={`jf-btn ${jFilter===val?"on":""}`} onClick={()=>setJFilter(val)}>{lbl}</button>
              ))}
            </div>
            <div className="jf-section">
              <span className="jf-label">Panel</span>
              <button className={`jf-btn ${!jPanel?"on":""}`} onClick={()=>setJPanel(null)}>All panels</button>
              {PANELS.map(p=>(
                <button key={p.id} className="jf-btn"
                  style={jPanel===p.id?{background:p.color,color:"#FFFFFF"}:{}}
                  onClick={()=>setJPanel(jPanel===p.id?null:p.id)}>
                  {p.icon} {p.label}
                </button>
              ))}
            </div>
          </div>
          <div className="journal-feed">
            {groups.length===0 ? (
              <div className="journal-empty">
                <div className="journal-empty-txt">Nothing here yet</div>
                <div className="journal-empty-sub">Write a note above or change your filters</div>
              </div>
            ) : groups.map(group=>(
              <div key={group.date} className="day-group">
                <div className="day-header">
                  <span className="day-date">{group.date}</span>
                  <span className="day-count">{group.entries.length} {group.entries.length===1?"entry":"entries"}</span>
                </div>
                {group.entries.map(entry=>{
                  const panels=(entry.panels||[]).map(id=>getPD(id)).filter(Boolean);
                  return (
                    <div key={entry.id} className="journal-entry">
                      <div className="je-meta">
                        <span className="je-time">{entry.time}</span>
                        {panels.map(pd=><span key={pd.id} className="j-tag" style={{background:pd.color}}>{pd.label}</span>)}
                        {entry.sourceType&&<span className="j-badge">{badgeMap[entry.sourceType]}</span>}
                        <button className="je-del" onClick={()=>delEntry(entry.id)}>âœ•</button>
                      </div>
                      {entry.sourceTitle&&<span className="je-src">â†³ {entry.sourceTitle}</span>}
                      <div className="je-text">{entry.text}</div>
                      {entry.takeaway&&(
                        <div className="je-takeaway">
                          <span className="je-takeaway-label">Your takeaway</span>
                          <div className="je-takeaway-text">{entry.takeaway}</div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            ))}
          </div>
        </div>
      </div>
    );
  }

  // â”€â”€ HOME PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const filtered = entries;

  return (
    <div style={{fontFamily:"DM Sans,sans-serif",background:"#F7F4EE",minHeight:"100vh",color:"#0D0D0D"}}>
      <style>{CSS}</style>
      <div className={`save-toast ${showSaved?"show":""}`}>âœ“ Saved</div>
      {showModal&&renderModal()}

      <Nav current="home" />
      <Masthead right="Personal Intelligence" />

      {/* SEARCH */}
      <div className="search-wrap">
        <span style={{fontSize:14,color:"#6B6B6B",padding:"18px 0"}}>âŒ•</span>
        <input className="search-input" placeholder="Search entries, sources, panelsâ€¦" value={searchQ} onChange={e=>setSearchQ(e.target.value)} />
        {searchQ&&<span className="search-count">{searchResults.length} result{searchResults.length!==1?"s":""}</span>}
        {searchQ&&<button className="search-clear" onClick={()=>setSearchQ("")}>Clear</button>}
      </div>

      {searchQ.trim().length > 1 ? (
        <div className="search-results">
          <div className="sr-hdr">Results for "{searchQ}"</div>
          {searchResults.length===0
            ? <div style={{textAlign:"center",padding:"60px 0",fontFamily:"Playfair Display,serif",fontSize:18,color:"#A8A8A0"}}>No results found</div>
            : searchResults.map(entry=>{
                const panels=(entry.panels||[]).map(id=>getPD(id)).filter(Boolean);
                return (
                  <div key={entry.id} className="sr-entry" onClick={()=>{if(panels[0]){setActivePanelId(panels[0].id);setView("panel");}}}>
                    <div className="j-meta">
                      <span className="j-date">{entry.date} Â· {entry.time}</span>
                      {panels.map(pd=><span key={pd.id} className="j-tag" style={{background:pd.color}}>{pd.label}</span>)}
                      {entry.sourceType&&<span className="j-badge">{badgeMap[entry.sourceType]}</span>}
                    </div>
                    {entry.sourceTitle&&<span className="j-src">â†³ {entry.sourceTitle}</span>}
                    <div className="j-txt" dangerouslySetInnerHTML={{__html:highlight(entry.text,searchQ)}} />
                    {entry.takeaway&&<div style={{marginTop:8,fontFamily:"Playfair Display,serif",fontSize:13,color:"#1B4D35",fontStyle:"italic"}}>â†³ {entry.takeaway}</div>}
                  </div>
                );
              })
          }
        </div>
      ) : (
        <>
          {/* READING NOW */}
          <div className="reading-now">
            <div className="rn-label-col">
              <div>
                <div className="rn-label">Reading Now</div>
                <div className="rn-icon">ðŸ“–</div>
              </div>
            </div>
            <div className="rn-body">
              {books.map((book,i)=>(
                <div key={book.id} className="rn-book" style={{"--bc":PANELS[i%PANELS.length].color}}>
                  <div className="rn-book-spine"></div>
                  <div className="rn-book-info">
                    <div className="rn-book-title">{book.title}</div>
                    {book.author&&<div className="rn-book-author">{book.author}</div>}
                  </div>
                  <button className="rn-book-del" onClick={()=>saveBooks(books.filter(b=>b.id!==book.id))}>âœ•</button>
                </div>
              ))}
              {books.length < 3 && !addingBook && (
                <button className="rn-add" onClick={()=>setAddingBook(true)}>+ Add book</button>
              )}
              {addingBook && (
                <div className="rn-add-form">
                  <input className="rn-add-inp" placeholder="Title" value={bookTitle} onChange={e=>setBookTitle(e.target.value)} autoFocus
                    onKeyDown={e=>{ if(e.key==="Enter"&&bookTitle.trim()){ saveBooks([...books,{id:Date.now(),title:bookTitle.trim(),author:bookAuthor.trim()}]); setBookTitle(""); setBookAuthor(""); setAddingBook(false); } if(e.key==="Escape") setAddingBook(false); }} />
                  <input className="rn-add-inp" placeholder="Author (optional)" value={bookAuthor} onChange={e=>setBookAuthor(e.target.value)} style={{borderLeft:"1px solid #D8D5CE"}}
                    onKeyDown={e=>{ if(e.key==="Enter"&&bookTitle.trim()){ saveBooks([...books,{id:Date.now(),title:bookTitle.trim(),author:bookAuthor.trim()}]); setBookTitle(""); setBookAuthor(""); setAddingBook(false); } if(e.key==="Escape") setAddingBook(false); }} />
                  <button className="rn-add-btn" onClick={()=>{ if(bookTitle.trim()){ saveBooks([...books,{id:Date.now(),title:bookTitle.trim(),author:bookAuthor.trim()}]); setBookTitle(""); setBookAuthor(""); setAddingBook(false); } }}>Add</button>
                </div>
              )}
            </div>
          </div>

          {/* WRITE BAR */}
          <div className="write-bar">
            <span className="write-lbl">Write</span>
            <input className="write-input" placeholder="What's on your mind?" value={writeText} onChange={e=>setWriteText(e.target.value)} onKeyDown={e=>e.key==="Enter"&&postNote(writeText,writePanel,()=>{setWriteText("");setWritePanel("");})} />
            <select className="write-sel" value={writePanel} onChange={e=>setWritePanel(e.target.value)}>
              <option value="">Tag panel...</option>
              {PANELS.map(p=><option key={p.id} value={p.id}>{p.label}</option>)}
            </select>
            <button className="post-btn" onClick={()=>postNote(writeText,writePanel,()=>{setWriteText("");setWritePanel("");})}>Post â†’</button>
            <button className="upload-btn" onClick={()=>setShowModal(true)}>â†‘ Upload</button>
          </div>

          {/* MAIN GRID */}
          <div className="main-grid">
            <div className="panels-section">
              <div className="sec-hdr">
                <span className="sec-title">Panels</span>
                <span className="sec-sub">{PANELS.length} active</span>
              </div>
              <div className="panel-grid">
                {PANELS.map(p=>{
                  const count = entries.filter(e=>(e.panels||[]).includes(p.id)).length;
                  return (
                    <div key={p.id} className="pc" style={{"--pc":p.color}} onClick={()=>{setActivePanelId(p.id);setView("panel");}}>
                      <span className="pc-icon">{p.icon}</span>
                      <div className="pc-name">{p.label}</div>
                      <div className="pc-count">{count} {count===1?"entry":"entries"}</div>
                    </div>
                  );
                })}
              </div>
            </div>

            {/* JOURNAL SIDEBAR */}
            <div className="j-sidebar">
              <div className="sec-hdr">
                <span className="sec-title">Recent</span>
                <span className="sec-sub">{filtered.length} {filtered.length===1?"entry":"entries"}</span>
              </div>
              <div className="filter-bar">
                <button className={`fb ${!filterPanel?"on":""}`} onClick={()=>setFilterPanel(null)}>All</button>
                {PANELS.map(p=>(
                  <button key={p.id} className={`fb ${filterPanel===p.id?"on":""}`}
                    style={filterPanel===p.id?{background:p.color,borderColor:p.color,color:"#FFFFFF"}:{}}
                    onClick={()=>setFilterPanel(filterPanel===p.id?null:p.id)}>
                    {p.icon}
                  </button>
                ))}
              </div>
              <div className="j-feed">
                {(filterPanel ? filtered.filter(e=>(e.panels||[]).includes(filterPanel)) : filtered).map(entry=>(
                  <div key={entry.id} className="j-entry">
                    <EntryCard entry={entry} />
                  </div>
                ))}
                {filtered.length===0&&<div style={{fontFamily:"Playfair Display,serif",fontSize:16,color:"#A8A8A0",padding:"24px 0"}}>Nothing yet â€” write something above.</div>}
              </div>
            </div>
          </div>

          {/* SOURCES */}
          <div className="sources">
            <div className="src-label">Sources</div>
            <div className="src-grid">
              {[
                ["Wall Street Journal","Business & markets","https://wsj.com"],
                ["Bloomberg","Finance & data","https://bloomberg.com"],
                ["Yahoo Finance","Markets & portfolio","https://finance.yahoo.com"],
                ["The Ringer","Sports & culture","https://theringer.com"],
                ["Prof G Pod","Scott Galloway","https://podcasts.apple.com/us/podcast/the-prof-g-pod-with-scott-galloway/id1498802610"],
                ["Plain English","Derek Thompson","https://podcasts.apple.com/us/podcast/plain-english-with-derek-thompson/id1596186727"],
                ["Pints with Aquinas","Matt Fradd","https://pintswithaaquinas.com"],
                ["Word on Fire","Bishop Barron","https://wordonfire.org"],
                ["Substack","Your subscriptions","https://substack.com"],
              ].map(([name,desc,href])=>(
                <div key={name} className="src-item">
                  <div className="src-name">{name}</div>
                  <div className="src-desc">{desc}</div>
                  <a className="src-link" href={href} target="_blank" rel="noreferrer">Open â†’</a>
                </div>
              ))}
            </div>
          </div>
        </>
      )}
    </div>
  );
}



  ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(Pangea, null));
  </script>
</body>
</html>